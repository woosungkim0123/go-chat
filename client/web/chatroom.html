<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Home Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        .chatbox {
            outline: 1px solid #000;
            min-height: 200px;
            padding: 0.5em;
        }
    </style>
</head>
<body>
{{template "header"}}

<div class="container py-5">
    <div class="row">
        <!-- 채팅 목록 -->
        <div class="col-md-8">
            <h3 class="mb-3">채팅</h3>
            <ul id="chatList" class="list-group mb-3 border" style="height: 400px; overflow-y: auto;">
                {{range .Messages}}
                {{if eq .User.Id $.AccessUser.Id}}
                <li class="list-group-item">
                    <div class="d-flex w-100 justify-content-start flex-column">
                        <small class="text-muted">{{.Time}}</small>
                        <small class="text-muted">{{.User.Name}}</small>
                        <div class="mb-1">{{.Message}}</div>
                    </div>
                </li>
                {{else}}
                <li class="list-group-item">
                    <div class="d-flex w-100 justify-content-end flex-column align-items-end">
                        <small class="text-muted">{{.Time}}</small>
                        <small class="text-muted">{{.User.Name}}</small>
                        <div class="mb-1">{{.Message}}</div>
                    </div>
                </li>
                {{end}}
                {{end}}
            </ul>
            <!-- 채팅 입력 -->
            <form id="chatForm" action="/send" method="POST">
                <div class="input-group mb-3">
                    <input id="roomId" type="hidden" name="room_id" value="{{.RoomId}}" />
                    <input id="userId" type="hidden" name="user_id" value="{{.AccessUser.Id}}" />
                    <textarea class="form-control" id="messageInput" name="message" rows="1" placeholder="메시지를 입력하세요..."></textarea>
                    <button type="submit" class="btn btn-primary">보내기</button>
                </div>
            </form>
        </div>

        <!-- 참여자 목록 -->
        <div class="col-md-4">
            <h3 class="mb-3">참여자</h3>
            <ul class="list-group">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{.AccessUser.Name}} (본인)
                    <span class="badge bg-primary rounded-pill">*</span>
                </li>

                {{range .Participants}}
                {{if ne .Id $.AccessUser.Id}}
                <li class="list-group-item">{{.Name}}</li>
                {{end}}
                {{end}}
            </ul>
        </div>
    </div>
</div>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
    const scrollToBottom = () => {
        const chatList = document.getElementById("chatList");
        chatList.scrollTop = chatList.scrollHeight;
    }

    let socket;
    const roomId = document.getElementById("roomId").value;
    const userId = document.getElementById("userId").value;
    let o = document.getElementById("output");
    let userField = document.getElementById("username");
    let messageField = document.getElementById("message");

    window.onbeforeunload = function () {
        let jsonData = {};
        jsonData["action"] = "left"
        socket.send(JSON.stringify(jsonData));
    }

    document.addEventListener('DOMContentLoaded', () => {
        scrollToBottom();
        socket = new WebSocket("ws://127.0.0.1:8080/ws");

        socket.onopen = () => {
            console.log('Connected to the server');
            socket.send(JSON.stringify({action: "join", userId: userId, roomId: roomId }));
        };

        socket.onmessage = msg => {
            let data = JSON.parse(msg.data);
            console.log(data)
            console.log("Action is", data.action);

            switch (data.action) {
                case "join":
                    console.log(data.message);
                    break;

                case "list_users":
                    let ul = document.getElementById("online_users");
                    while (ul.firstChild) ul.removeChild(ul.firstChild);

                    if (data.connected_users.length > 0) {
                        data.connected_users.forEach(function (item) {
                            let li = document.createElement("li");
                            li.appendChild(document.createTextNode(item));
                            ul.appendChild(li);
                        })
                    }
                    break;

                case "broadcast":
                    o.innerHTML = o.innerHTML + data.message + "<br>";
                    break;
            }
        }

        socket.onclose = () => {
            console.log('Connection to the server closed');
        };

        socket.onerror = (error) => {
            console.error('Error:', error);
        };

        // let userInput = document.getElementById("username");
        //         userInput.addEventListener("change", function () {
        //             let jsonData = {};
        //             jsonData["action"] = "username";
        //             jsonData["username"] = this.value;
        //             socket.send(JSON.stringify(jsonData));
        // })

        // document.getElementById("message").addEventListener("keydown", function (e) {
        //     if (e.code === "Enter") {
        //         if ((userField.value === "") || (messageField.value === "")) {
        //             alert("Please enter a username and message");
        //             return false;
        //         }
        //
        //         if (!socket) {
        //             console.error("Socket connection is not available");
        //             return false;
        //         }
        //
        //         e.preventDefault();
        //         e.stopPropagation();
        //         sendMessage();
        //     }
        // });
        //
        // document.getElementById("sendBtn").addEventListener("click", function () {
        //     if ((userField.value === "") || (messageField.value === "")) {
        //         alert("Please enter a username and message");
        //         return false;
        //     }
        //
        //     if (!socket) {
        //         console.error("Socket connection is not available");
        //         return false;
        //     }
        //
        //     sendMessage();
        // });
    });

    const sendMessage = () => {
        let jsonData = {};
        jsonData["action"] = "broadcast";
        jsonData["username"] = document.getElementById("username").value;
        jsonData["message"] = document.getElementById("message").value;
        socket.send(JSON.stringify(jsonData));
        document.getElementById("message").value = "";
    }

</script>
</html>
